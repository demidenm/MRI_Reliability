[![Python package](https://github.com/demidenm/PyReliMRI/actions/workflows/python-package-conda.yml/badge.svg?style=plastic&logo=Python)](https://github.com/demidenm/PyReliMRI/actions/workflows/python-package-conda.yml) 

[![Documentation Status](https://readthedocs.org/projects/pyrelimri/badge/?version=latest&style=plastic)](https://pyrelimri.readthedocs.io/en/latest/?badge=latest&style=plastic)
[![Funded By](https://img.shields.io/badge/NIDA-F32%20DA055334--01A1-yellowgreen?style=plastic)](https://reporter.nih.gov/project-details/10525501)
[![DOI](https://zenodo.org/badge/576430868.svg)](https://zenodo.org/badge/latestdoi/576430868)

<img src="docs/img_png/pyrelimri_logo.png" alt="Pyrelimri Logo" style="width:50%;">

# Python-based Reliability in MRI (PyReliMRI)

PyReliMRI is described and used in the [Preprint](https://www.doi.org/10.1101/2024.03.19.585755)
<img src="docs/img_png/pyrelimri_fig.png" alt="Pyrelimri Features" style="width:100%;">


## Authors

[Michael I. Demidenko](https://orcid.org/0000-0001-9270-0124) & [Russell A. Poldrack](https://orcid.org/0000-0001-6755-0259)

### Citation

If you use PyReliMRI in your research, please cite the following Zenodo DOI:
Demidenko, M. I., & Poldrack, R. A. (2023). PyReliMRI: An Open-source Python tool for Estimates of Reliability in MRI Data [Computer software]. https://zenodo.org/record/8387971

## Intro of Problem

Reliability questions for [task fMRI](https://www.doi.org/10.1177/0956797620916786) and [resting state fMRI](https://www.doi.org/10.1016/j.neuroimage.2019.116157) are increasing. As described in [2010](https://www.doi.org/10.1111/j.1749-6632.2010.05446.x), there are various ways that researchers calculate reliability. Few open-source packages exist to calculate multiple individual and group reliability metrics using one tool.

## Purpose of Script

The purpose of this package is to provide an open-source python package that will provide multiple reliability metrics, at the group and individual level, that researchers may use to report in their manuscripts in cases of multi-run and/or multi-session data.
 - At the group level, [similarity.py](/pyrelimri/similarity.py) calculates a similarity calculations between two fMRI images using Dice or Jaccard similarity coefficients, or tetrachoric or spearman rank correlation. In addition to calculate the similarity between two images, a function is provided to pairwise comparisons across a list of 3D images and return a list of coefficients.
 - At the individual level, the [brain_icc.py](/pyrelimri/brain_icc.py) calculates voxel-wise and atlas based (see [Nilearn deterministic/probabilistic atlases](https://nilearn.github.io/dev/modules/datasets.html#atlases)) ICC(1), ICC(2,1) or ICC(3,1). For description of different ICCs and their calculations, see discussion in [Liljequist et al., 2019](https://www.doi.org/10.1371/journal.pone.0219854). 
 - The [conn_icc.py](/pyrelimri/conn_icc.py)  includes the option for edgewise ICCs for already estimate correlation matrices for subjects/runs/sessions.
 - To further improve interpretability of fMRI models, [masked_timeseries.py](/pyrelimri/masked_timeseries.py) provides and quick an effortless option to extract timeseries percent signal change for an ROI mask (or specific coordinates + radius) from a list of normalized brain images. It returns a time series that can then be used with behavioral onsets to lock timeseries data to events and plot TR-by-TR for a given delay. This provides a quick and easy comparison between response of BOLD within a given region for 1+ conditions.


| **Script Name**                                                     | **Functions**                                                                                                                                                                                                   | **Inputs**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | **Purpose**                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|:--------------------------------------------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [brain_icc.py](/pyrelimri/brain_icc.py)                             | voxelwise_icc, roi_icc                                                                                                                                                                                          | [VOXELWISE_ICC] REQUIRED:<br>List of list of paths to 3D Nifti for 1+ sessions data,<br>brain mask<br>OPTIONAL:<br>ICC type (icc_type; default = 'icc_3', options include: 'icc_3','icc_2','icc_1') [ROI_ICC] REQUIRED:<br>List of list of paths to 3D Nifti for 1+ sessions data,<br>type_atlas, atlas_dir, atlas specific variables via kwargs** <br>OPTIONAL:<br> ICC type (icc_type; default = 'icc_3', options include: 'icc_3','icc_2','icc_1')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Calculate the intraclass correlation (e.g., ICC(1), ICC(2,1), or ICC(3,1) for 3D volumes across 1+ sessions, returning six 3D volumes reflecting the ICC estimate, the 95% lowerbound for ICC estimate, 95% upperbound for ICC estimate, between subject variance, within subject variance, and for ICC(2,1) between measure variance. In case of ROI icc, returns atlas labels plus array six arrays estimates and six 3D images of estimates. |
| [icc.py](/pyrelimri/icc.py)                                         | sumsq_total,<br>sumsq,<br>sumsq_btwn,<br>icc_confint,<br>sumsq_icc                                                                                                                                              | REQUIRED:<br>Panda long dataframe with a subject variable (sub_var),<br>session variable (sess_var),<br>the scores (value_var) and the icc type (icc_type; default = 'icc_3', options include: 'icc_3','icc_2','icc_1')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Calculates sum of squares total, error, within and between to return an ICC estimate (e.g., ICC(1), ICC(2,1), or ICC(3,1), 95% lowerbound and 95% upperbound for ICC, between subject variance, within-subject variance, and for ICC(2,1) between measure variance.                                                                                                                                                                             |
| [similarity.py](/pyrelimri/similarity.py)                           | image_similarity,<br>pairwise_similarity                                                                                                                                                                        | REQUIRED:<br>Path to 3D Nifti imgfile1,<br>Path to 3D Nifti imgfile2 <br>OPTIONAL:<br>Path to a mask,<br>threshold (thresh) on the images,<br>Type (similarity_type) of image similarity coefficient (default = 'dice', options include: 'dice', 'jaccard', 'tetrachoric', 'spearman')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Calculate the similarity between two images. Pairwise_similarity: across multiple image pairs calculate similarity coefficient between all possible combinations.                                                                                                                                                                                                                                                                               |
| [tetrachoric_correlation.py](/pyrelimri/tetrachoric_correlation.py) | tetrachoric_corr                                                                                                                                                                                                | REQUIRED:<br>Binary vector NDarray,<br>Binary vector NDarray                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Calculate the tetrachoric correlation between two binary vectors.                                                                                                                                                                                                                                                                                                                                                                               |
| [conn_icc.py](/pyrelimri/conn_icc.py)                               | triang_to_fullmat, edgewise_icc                                                                                                                                                                                 | REQUIRED:<br>REQUIRED:List of list of paths to .npy, .txt, .csv or lists of lists to ndarrays for 1+ sessions computed correlation matrices                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Calculate the edge wise ICC estimates for correlation matrices and returnd dictionary with estimates.                                                                                                                                                                                                                                                                                                                                           |
| [masked_timeseries.py](/pyrelimri/masked_timeseries.py) | [Primary] extract_time_series, extract_postcue_trs_for_conditions, plot responses. [secondary] trlocked_events, extract_time_series_values, process_bold_roi_mask, process_bold_roi_coords, extract_time_series | [extract_time_series] REQUIRED:<br>List to Nifti bold paths, ROI type (i.e., 'mask' or 'cords'), high pass filter (to run or not, default = None), ROI mask (path to mask, if roi_type = 'mask'), ROI coordinates (tuple (12,34,21) if roi_type = 'coords') radius MM (if using coords), whether to detrend (defualt = None), FWHM smoothing (default = None), number of CPUs (n_jobs =1) to paralleize. Depending on data, need 15gb per CPU. [extract_postcue_trs_for_conditions] REQUIRED:<br> list of events data paths (order subject/runs/sessions should match BOLD paths), column in behavioral file that specifies time of event (onset), column specifying conditions for event (trial_name), BOLD TR (e.g 2.0), BOLD Volumes (e.g., 150), timeseries array (time_series, output from [extract_time_series]), events to lock to TR in timeseries (conditions), number of TRs after onset to use from timeseries (delay), subject file order of BOLD paths (list_trpaths, list output from [extract_time_series]) | Extracts timeseries from BOLD files for a given ROI and locks to stimulus onset for plotting/visualization of percent signal change.                                                                                                                                                                                                                                                                                                            |
